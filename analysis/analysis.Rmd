--- 
title: "Comparison class inference free production pilot"
author: "Polina Tsvilodub"
date: "08/18/2019"
output: github_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

``` {r}
library(tidyverse)
library(tidyboot)
library(brms)
```

``` {r}
d1 <- read_csv("../data/results_9_comp-class-inference-pred_batch2.csv")
d2 <- read_csv("../data/results_9_comp-class-inference-prenom_batch2.csv")
d3 <- read_csv("../data/results_9_comp-class-inference-pilot.csv")

d4 <- rbind(d1, d2)

# add the missing column condition to d3 (pilot data)
d3["condition"] <-  ifelse(grepl("That's", d3$text), "prenominal", "predicative")

d <- rbind(d4, d3)

glimpse(d)
```
``` {r}
d %>% distinct(d$languages)# %>% View()
d_filt <- d %>% 
  filter(grepl("english", languages, ignore.case = T))

# choose main trials 
d_main <- d_filt %>% filter((trial_name == "custom_main_text1")|(trial_name == "custom_main_text2")) %>% select(submission_id, trial_number, ref_spec, pic_spec, item, response, condition, context, text)

d_main %>% distinct(d_main$response) %>% View()
d_comments <- d %>% distinct(d$comments) %>% View()
```
## Response categorization
```{r}
# remove invalid responses 
d_main_valid <- subset(d_main, !(response %in% c("Yes", "That one is big", "That chihuahua is small", "That great dane is big", "those dogs are small", "the swordfish are big", "those eagles are big", "those dandelions are small", "that tree on the far left is big", "that pug on the left is small", "ones", "this is a little pug", "there is a little bonsai", "that's a big dog", "that sunflower is large", "that is a little bird", "that fish is large" ))) 

# categorize responses
d_main_responseCat <- d_main_valid %>%
  rowwise() %>%
  mutate(  
    response_cat =
      ifelse(
      tolower(response) %in% c("birds", "dogs", "fish", "flowers", "flower", "large dogs", "dogs in the line", "other birds in the group", "small dogs", "trees"), "basic", ifelse(tolower(response) %in% c("plant", "animal"), "super", "sub")),
    
    response_num = ifelse(response_cat == "sub", 1, 0),
    response_label = "sub"
  )

```

``` {r}
# raw reponse counts by syntactic condition (6 participants each)
 d_main_responseCat %>% ggplot(aes(x=response_cat)) + geom_bar(position=position_dodge()) + facet_wrap(~condition) 
```
## Proportion of sub responses by syntactic condition, picture specificity and NP specificity 

Expectations: When the underspecified 'one' is used, participants infer the comparison class froom the perceptual context: subordinate label (comparison class) for the subordinate parade, basic-level label for the basic-level parade. When thue subordinate noun phrase is used, the prenominal syntax sets the comparison class, whereas the predicative syntax allows for stronger context influence: more basic-level labels in the basic-level context are expected than in the subordinate context. 

``` {r}
#d_main_responseCat %>% group_by(response_label, ref_spec, pic_spec, condition) %>% tidyboot_mean(column = response_num) %>% ungroup() %>%   mutate(NP_spec = factor(ref_spec, levels= c(0, 1), labels = c("sub", "one")), condition = factor(condition, levels = c("predicative", "prenominal"), labels = c("That NP is big", "That's a big NP")), context_spec = factor(pic_spec, levels = c(0, 1), labels = c("basic", "sub"))) %>% ggplot(aes(x=context_spec, fill= NP_spec, y = mean, ymin = ci_lower, ymax = ci_upper)) +   geom_col(position = position_dodge(0.8))+   geom_linerange(position = position_dodge(0.8)) + facet_wrap(~condition)
```
## Sub responses proportion by noun phrase 
``` {r}
 # d_main_responseCat %>% group_by(response_label, ref_spec, pic_spec, condition) %>% tidyboot_mean(column = response_num) %>% ungroup() %>% 
#  mutate(NP_spec = factor(ref_spec, levels= c(0, 1), labels = c("subordinate", "one")), condition = factor(condition, levels = c("predicative", "prenominal"), labels = c("That NP is big", "That's a big NP")), context_spec = factor(pic_spec, levels = c(0, 1), labels = c("basic", "sub"))) %>% ggplot(aes(x=context_spec, fill= condition, y = mean, ymin = ci_lower, ymax = ci_upper)) + geom_col(position = position_dodge(0.8))+  geom_linerange(position = position_dodge(0.8)) + facet_wrap(~NP_spec)
```
## Sub responses proportion by context condition
``` {r}
d_main_responseCat %>% group_by(response_label, ref_spec, pic_spec, condition) %>% tidyboot_mean(column = response_num) %>% ungroup() %>% 
  mutate(NP = factor(ref_spec, levels= c(0, 1), labels = c("subordinate", "one")),
         condition = factor(condition, levels = c("predicative", "prenominal"), labels = c("That NP is big", "That's a big NP")), context_spec = factor(pic_spec, levels = c(0, 1), labels = c("basic", "sub"))) %>% ggplot(aes(x=condition, fill= NP, y = mean, ymin = ci_lower, ymax = ci_upper)) + geom_col(position = position_dodge(0.8))+   geom_linerange(position = position_dodge(0.8)) + facet_wrap(~context_spec)  
```

## Stats
``` {r}


library(lme4)
lm.fit <- glmer(response_num ~ condition*ref_spec*pic_spec + (1|submission_id), data = d_main_responseCat, family = "binomial" )
summary(lm.fit)
```
## Table 
``` {r}
d_main_responseCat %>% group_by(condition, ref_spec, pic_spec) %>% count()

```
## Sub response proportions by item and syntactic condition
``` {r}
d_main_responseCat %>% group_by(item, condition, response_label, ref_spec, pic_spec) %>% 
  tidyboot_mean(column = response_num) %>% ungroup() %>% 
  mutate(NP_spec = factor(ref_spec, levels= c(0, 1), labels = c("sub", "one")),
         context_spec = factor(pic_spec, levels = c(0, 1), labels = c("basic", "sub"))) %>% ggplot(aes(x=context_spec, fill= NP_spec, y = mean, ymin = ci_lower, ymax = ci_upper)) +
  geom_col(position = position_dodge(0.8))+
  geom_linerange(position = position_dodge(0.8)) + facet_grid(condition~item)
```
## Sub responses proportion per participant
``` {r}
d_main_responseCat %>%
  group_by(submission_id, condition, response_label, ref_spec, pic_spec) %>%
  summarize(n_sub_responses = sum(response_num)) %>%
  ungroup() %>% mutate(NP_spec = factor(ref_spec, levels= c(0, 1), labels = c("sub", "one")), context_spec = factor(pic_spec, levels = c(0, 1), labels = c("basic", "sub"))) %>%
  ggplot(., aes( x = n_sub_responses, fill=condition))+
  geom_bar(position=position_dodge())+
  facet_grid(NP_spec~context_spec) + ggtitle("Number of subordinate responses uttered per participant in the 6 trials")
```